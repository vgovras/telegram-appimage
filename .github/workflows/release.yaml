name: Build and Release

on:
  schedule:
    - cron: '0 0 * * *'  # Щодня о півночі UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build (skip version check)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Check version
        id: version
        run: |
          FORCE="${{ inputs.force }}"
          
          if [ "$FORCE" = "true" ]; then
            LATEST=$(./version.sh)
            echo "version=$LATEST" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST=$(./version.sh | tr -d '[:space:]')
          
          # Get last release from GitHub API (same approach as Telegram version check)
          REPO="${{ github.repository }}"
          LAST_TAG=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep -o '"tag_name":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
          LAST=$(echo "$LAST_TAG" | sed 's/^v//' | tr -d '[:space:]')
          
          echo "Latest version: $LATEST"
          echo "Last release: $LAST"
          
          if [ -z "$LAST" ] || [ "$LATEST" != "$LAST" ]; then
            echo "version=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: Build and release
        if: steps.version.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y zsync
          chmod +x build.sh version.sh
          ./build.sh
          
          APPIMAGE=$(find . -name "Telegram-*.AppImage" ! -name "linuxdeploy-*" | head -1)
          VERSION=${{ steps.version.outputs.version }}
          TAG="v$VERSION"
          
          gh release delete "$TAG" --yes 2>/dev/null || true
          FILES="$APPIMAGE"
          [ -f "${APPIMAGE}.zsync" ] && FILES="$FILES ${APPIMAGE}.zsync"
          gh release create "$TAG" $FILES --title "Telegram $VERSION" --generate-notes

