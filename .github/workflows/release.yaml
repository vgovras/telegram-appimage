name: Build and Release

on:
  schedule:
    - cron: '0 0 * * *'  # Щодня о півночі UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build (skip version check)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Check version
        id: version
        run: |
          FORCE="${{ inputs.force }}"
          
          if [ "$FORCE" = "true" ]; then
            LATEST=$(./version.sh)
            echo "version=$LATEST" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST=$(./version.sh)
          LAST=$(gh release view --json tagName -q '.tagName // "v0"' | sed 's/^v//')
          
          if [ "$LATEST" = "$LAST" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "version=$LATEST" >> $GITHUB_OUTPUT
      
      - name: Build and release
        if: steps.version.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y zsync
          chmod +x build.sh version.sh
          ./build.sh
          
          APPIMAGE=$(find . -name "Telegram-*.AppImage" ! -name "linuxdeploy-*" | head -1)
          VERSION=${{ steps.version.outputs.version }}
          TAG="v$VERSION"
          
          gh release delete "$TAG" --yes 2>/dev/null || true
          FILES="$APPIMAGE"
          [ -f "${APPIMAGE}.zsync" ] && FILES="$FILES ${APPIMAGE}.zsync"
          gh release create "$TAG" $FILES --title "Telegram $VERSION" --generate-notes

